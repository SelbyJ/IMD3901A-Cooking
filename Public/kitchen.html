<html>
  <head>
    <!-- SCRIPTS -->
    <script src="js/aframe-v0.8.2.min.js"></script>
    <script src="js/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/super-hands/dist/super-hands.min.js"></script>
    <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v3.1.2/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@^4.1.1/dist/aframe-event-set-component.min.js"></script>
    <script src="https://unpkg.com/aframe-physics-extras/dist/aframe-physics-extras.min.js"></script>
    <script src="https://rawgit.com/feiss/aframe-environment-component/master/dist/aframe-environment-component.min.js"></script>
    <script src="js/grabObj.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <title>Kitchen</title>
    <script>
        AFRAME.registerComponent('cookingimplement', {
            /*
                currentHeat: represents the current heat of the element
                maxHeat: represents the maximum heat the element can reach
                recieveHeat: 
                    if true then the element can't set it's own heat and needs to be placed on an element that can
                    if false then the element can set it's own heat and sends its current heat to the sendHeat object
                sendHeat: if recieveHeat is false then this value represents an object id that needs this elements heat 
            */
            schema:{
                currentHeat: {default: 0},
                maxHeat: {default: 100},
                recieveHeat: {default: false},
                sendHeat: {default: "null"}
            },

            init: function(){
                var obj = this.el;
                const Context_AF = this;
                var objData = this.data;
                //if true then it is an element like the burner or pan and it's heat is regulated by what it is on
                //if false then it is an elment like the burner knobs or oven gauge that sets the temerature for an element like the burner
                if(this.data.recieveHeat){
                    obj.addEventListener('collide', function(e){
                        if(e.detail.body.el.getAttribute('cookingimplement') !== null){
                            //objData.currentHeat = ;
                            console.log(e.detail.body.el.getAttribute('cookingimplement'));
                            switch(objData.currentHeat){
                                case 90:
                                    obj.setAttribute("material", {color: "green"});    
                                    break;
                                case 180:
                                    obj.setAttribute("material", {color: "yellow"});    
                                    break;
                                case 270:
                                    obj.setAttribute("material", {color: "orange"});    
                                    break;
                                case 360:
                                    obj.setAttribute("material", {color: "red"});  
                                    break;
                            }
                        }
                    });
                }
                else{
                    obj.addEventListener('collide', function(e){
                        if(e.detail.body.el.getAttribute('id') === "lhand" || e.detail.body.el.getAttribute('id') === "rhand"){
                            if(objData.currentHeat < 360){
                                objData.currentHeat += 90;
                                document.getElementById(objData.sendHeat).setAttribute("cookingimplement", {currentHeat: objData.currentHeat});
                                switch(objData.currentHeat){
                                    case 90:
                                        document.getElementById(objData.sendHeat).setAttribute("material", {color: "green"});    
                                        break;
                                    case 180:
                                        document.getElementById(objData.sendHeat).setAttribute("material", {color: "yellow"});    
                                        break;
                                    case 270:
                                        document.getElementById(objData.sendHeat).setAttribute("material", {color: "orange"});    
                                        break;
                                    case 360:
                                        document.getElementById(objData.sendHeat).setAttribute("material", {color: "red"});  
                                        break;
                                }
                            }
                            else{
                                objData.currentHeat = 0;
                                document.getElementById(objData.sendHeat).setAttribute("cookingimplement", {currentHeat: objData.currentHeat});
                                document.getElementById(objData.sendHeat).setAttribute("material", {color: "purple"});   
                            }
                        }
                    });
                }
            }
        }),

        AFRAME.registerComponent('ingredient', {
            /*
                heatTransfer: represents the heat needed to cook, once the value reaches 0 the ingredient is cooked if it goes below then it is overcooked 
                size: represents the size the recipe specifies the ingredient needs to be
                cookingImplementID
            */
            schema: {
                heatTransfer: {default: 0},
                size: {default: 1},
                cookingImplementID: {default: "NULL"}
            },

            init: function(){
                const Context_AF = this;
                var obj = this.el;
                var objData = this.data;
                //Collision events
                obj.addEventListener('collide', function(e){
                    //Cutting events
                    if(objData.size < 1){
                        //if the cube collides with the knife
                        if(e.detail.body.el.getAttribute('id') === 'knife-entity'){
                            objData.size = objData.size / 2;
                            let cubeObj1 = document.createElement('a-entity');
                            let cubeObj2 = document.createElement('a-entity');

                            let cubeObjPos = obj.getAttribute('position');
                            let cubeObjScale = obj.getAttribute('scale');

                            cubeObj1.setAttribute('position', {x: cubeObjPos.x - cubeObjScale.x /2, y: cubeObjPos.y, z: cubeObjPos.z});
                            cubeObj1.setAttribute('mixin', "cube");
                            cubeObj1.setAttribute('scale', {x: cubeObjScale.x /2, y: cubeObjScale.y / 2, z: cubeObjScale.z / 2});

                            cubeObj2.setAttribute('position', {x: cubeObjPos.x + cubeObjScale.x /2, y: cubeObjPos.y, z: cubeObjPos.z});
                            cubeObj2.setAttribute('mixin', "cube");
                            cubeObj2.setAttribute('scale', {x: cubeObjScale.x /2, y: cubeObjScale.y / 2, z: cubeObjScale.z / 2});

                            let scene = document.querySelector('a-scene');
                            scene.appendChild(cubeObj1);
                            scene.appendChild(cubeObj2);

                            obj.setAttribute('delete-self', {delete: true});
                        }
                    }
                    if(e.detail.body.el.getAttribute('id') === objData.cookingImplementID){
                        Context_AF.heatObj(e);
                    }
                });
            },

            heatObj: function(e){
                var heat = e.detail.body.el.getAttribute('cookingImplement').currentHeat;
                console.log(heat);
            }
        }), 

        AFRAME.registerComponent('collision',{
            schema: {
                collision: {default: false}
            }
        }),

        AFRAME.registerComponent('phase-shift', {
            init: function () {
                var el = this.el
                el.addEventListener('gripdown', function () {
                    el.setAttribute('collision-filter', {collisionForces: true})
                    console.log("button Press");
                })
                el.addEventListener('gripup', function () {
                    el.setAttribute('collision-filter', {collisionForces: false})
                    console.log("button let go");
                })
            }
        });
        
        AFRAME.registerComponent('delete-self', {
                schema:{
                    delete: {default: false}
                },
                init: function(){
                },

                tick: function(){
                    const Context_AF = this;
                    var el = this.el;
                    if(this.data.delete === true) {
                        Context_AF.deleteMyself();
                    }
                },

                deleteMyself: function(){
                    const Context_AF = this;
                    Context_AF.el.parentNode.removeChild(Context_AF.el); 
                }
            });
    </script>
  </head>
  <body>
    
    <a-scene physics="debug: true">
      <a-assets>
        <a-asset-item id="kitchenTop-obj" src="assets/models/kitchenTop.obj"></a-asset-item>
        <a-asset-item id="knife-obj" src="assets/models/knife.obj"></a-asset-item>
        <a-asset-item id="mushroom-obj" src="assets/models/mushroom.obj"></a-asset-item>
        <a-asset-item id="pan-obj" src="assets/models/pan.obj"></a-asset-item>

        <!--STOVE ELEMENTS-->
        <a-asset-item id="stoveBase-obj" src="assets/models/stoveBase.obj"></a-asset-item>
        <a-asset-item id="frontRightBurner-obj" src="assets/models/frontRightBurner.obj"></a-asset-item>
        <a-asset-item id="frontRightBurnerKnob-obj" src="assets/models/frontRightBurnerKnob.obj"></a-asset-item>
        <a-asset-item id="frontLeftBurner-obj" src="assets/models/frontLeftBurner.obj"></a-asset-item>
        <a-asset-item id="frontLeftBurnerKnob-obj" src="assets/models/frontLeftBurnerKnob.obj"></a-asset-item>
        <a-asset-item id="backRightBurner-obj" src="assets/models/backRightBurner.obj"></a-asset-item>
        <a-asset-item id="backRightBurnerKnob-obj" src="assets/models/backRightBurnerKnob.obj"></a-asset-item>
        <a-asset-item id="backLeftBurner-obj" src="assets/models/backLeftBurner.obj"></a-asset-item>
        <a-asset-item id="backLeftBurnerKnob-obj" src="assets/models/backLeftBurnerKnob.obj"></a-asset-item>

        <!--MIXIN-->
        <a-mixin id="objectGrab" hoverable grabbable
            event-set__hoveron="_event: hover-start; material.opacity: 0.7; transparent: true"
            event-set__hoveroff="_event: hover-end; material.opacity: 1; transparent: false"
            shadow collision></a-mixin>

        <a-mixin id="objectHold" hoverable grabbable stretchable draggable
            event-set__hoveron="_event: hover-start; material.opacity: 0.7; transparent: true"
            event-set__hoveroff="_event: hover-end; material.opacity: 1; transparent: false"
            shadow delete-self="delete: false;" collision></a-mixin>
            
        <a-mixin id="cube" geometry="primitive: box;"
                hoverable grabbable stretchable draggable
                event-set__hoveron="_event: hover-start; material.opacity: 0.7; transparent: true"
                event-set__hoveroff="_event: hover-end; material.opacity: 1; transparent: false"
                dynamic-body shadow delete-self="delete: false;" collision></a-mixin>
        
        <a-mixin id="touch"
                physics-collider phase-shift
                collision-filter="collisionForces: false"
                static-body="shape: sphere; sphereRadius: 0.02"
                super-hands="colliderEvent: collisions;
                                colliderEventProperty: els;
                                colliderEndEvent: collisions;
                                colliderEndEventProperty: clearedEls;">
      </a-assets>
      <!--PLAYER -->
      <a-entity>
          <a-camera positon="0 1.6 0"></a-camera>
          <a-entity id="rhand" mixin="touch"
                    vive-controls="hand: right"
                    oculus-touch-controls="hand: right"
                    windows-motion-controls="hand: right">
          </a-entity>
          <a-entity id="lhand" mixin="touch"
                    vive-controls="hand: left"
                    oculus-touch-controls="hand: left"
                    windows-motion-controls="hand: left">
          </a-entity>
      </a-entity>
      <a-sky color="#1e559e"></a-sky>

      <a-entity static-body obj-model="obj: #kitchenTop-obj;" scale ="0.01 0.01 0.01"></a-entity>

      <a-entity  id="knife-entity" obj-model="obj: #knife-obj;" dynamic-body mixin="objectHold" position="0.5 1.4 -0.5" material="color: black" scale ="0.02 0.02 0.02"></a-entity>

      <a-entity id="mushroom-entity" obj-model="obj: #mushroom-obj;" dynamic-body mixin="objectHold" position="1.2 1.9 -0.1" scale ="0.01 0.01 0.01" material="color: black" ingredient="size: 1; heatTransfer: 0; cookingImplementID: pan-entity;"></a-entity>
      
      <a-entity id="cube-entity" mixin="cube" position="0.4 1.4 -0.1" scale ="0.2 0.2 0.2" material="color: red"></a-entity>
      
      <!--STOVE ENTITY-->
      <a-entity position="1 0 0.2" scale ="0.009 0.009 0.009">
        <a-entity id="stoveBase-entity" obj-model="obj: #stoveBase-obj;" material="color: white"></a-entity>
        <a-entity static-body id="frontRightBurner-entity" obj-model="obj: #frontRightBurner-obj;" material="color: purple" cookingimplement="currentHeat: 0;maxHeat: 360;recieveHeat: true; sendHeat: NULL"></a-entity>
        <a-entity static-body id="frontLeftBurner-entity" obj-model="obj: #frontLeftBurner-obj;" material="color: purple" cookingimplement="currentHeat: 0;maxHeat: 360;recieveHeat: true; sendHeat: NULL"></a-entity>
        <a-entity static-body id="backRightBurner-entity" obj-model="obj: #backRightBurner-obj;" material="color: purple" cookingimplement="currentHeat: 0;maxHeat: 360;recieveHeat: true; sendHeat: NULL"></a-entity>
        <a-entity static-body id="backLeftBurner-entity" obj-model="obj: #backLeftBurner-obj;" material="color: purple" cookingimplement="currentHeat: 0;maxHeat: 360;recieveHeat: true; sendHeat: NULL"></a-entity>

        <a-entity id="backLeftBurnerKnob-entity" obj-model="obj: #backLeftBurnerKnob-obj;" static-body mixin="objectGrab" material="color: black" cookingimplement="currentHeat: 0;maxHeat: 360;recieveHeat: false;sendHeat: backLeftBurner-entity;"></a-entity>
        <a-entity id="backRightBurnerKnob-entity" obj-model="obj: #backRightBurnerKnob-obj;" static-body mixin="objectGrab" material="color: black" cookingimplement="currentHeat: 0;maxHeat: 360;recieveHeat: false;sendHeat: backRightBurner-entity;"></a-entity>
        <a-entity id="frontLeftBurnerKnob-entity" obj-model="obj: #frontLeftBurnerKnob-obj;" static-body mixin="objectGrab" material="color: black" cookingimplement="currentHeat: 0;maxHeat: 360;recieveHeat: false;sendHeat: frontLeftBurner-entity;"></a-entity>
        <a-entity id="frontRightBurnerKnob-entity" obj-model="obj: #frontRightBurnerKnob-obj;" static-body mixin="objectGrab" material="color: black" cookingimplement="currentHeat: 0;maxHeat: 360;recieveHeat: false;sendHeat: frontRightBurner-entity;"></a-entity>
      </a-entity>

      <a-entity id="pan-entity" obj-model="obj: #pan-obj;" dynamic-body mixin="objectHold" position="1.2 1.6 -0.1" scale ="0.2 0.2 0.2" material="color: orange" cookingimplement="currentHeat: 0; maxHeat: 360; recieveHeat: true;"></a-entity>

      <a-plane id="plane" static-body position="0 0 0" scale="10 10 10" rotation="-90 0 0" color="#8E8E8E"></a-plane>
      
    </a-scene>
  </body>
</html>