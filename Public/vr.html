<html>
  <head>
    <!-- SCRIPTS -->
    <script src="js/aframe-v0.8.2.min.js"></script>
    <script src="js/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/super-hands/dist/super-hands.min.js"></script>
    <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v3.1.2/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@^4.1.1/dist/aframe-event-set-component.min.js"></script>
    <script src="https://unpkg.com/aframe-physics-extras/dist/aframe-physics-extras.min.js"></script>
    <script src="https://rawgit.com/feiss/aframe-environment-component/master/dist/aframe-environment-component.min.js"></script>
    <script src="js/grabObj.js"></script>
    <script>
        AFRAME.registerComponent('collision',{
            schema: {
                collision: {default: false}
            }
        }),

        AFRAME.registerComponent('knife-detection', {
            schema:{},

            init: function(){
                var obj = this.el;
                obj.addEventListener('collide', function (e) {
                    if(e.detail.body.el.getAttribute('id') === 'cube-entity' && e.detail.body.el.getAttribute('collision').collision === false){
                        e.detail.body.el.setAttribute('collision', {collision: true});

                        let cubeObj1 = document.createElement('a-entity');
                        let cubeObj2 = document.createElement('a-entity');

                        let cubeObjPos = e.detail.body.el.getAttribute('position');
                        let cubeObjScale = e.detail.body.el.getAttribute('scale');

                        cubeObj1.setAttribute('position', {x: cubeObjPos.x - cubeObjScale.x /2, y: cubeObjPos.y, z: cubeObjPos.z});
                        cubeObj1.setAttribute('mixin', "cube");
                        cubeObj1.setAttribute('scale', {x: cubeObjScale.x /2, y: cubeObjScale.y / 2, z: cubeObjScale.z / 2});

                        cubeObj2.setAttribute('position', {x: cubeObjPos.x + cubeObjScale.x /2, y: cubeObjPos.y, z: cubeObjPos.z});
                        cubeObj2.setAttribute('mixin', "cube");
                        cubeObj2.setAttribute('scale', {x: cubeObjScale.x /2, y: cubeObjScale.y / 2, z: cubeObjScale.z / 2});
                        
                        e.detail.body.el.setAttribute('delete-self', {delete: true});

                        let scene = document.querySelector('a-scene');
                        scene.appendChild(cubeObj1);
                        scene.appendChild(cubeObj2);
                    }

                    if(e.detail.body.el.getAttribute('id') === 'pan2-entity'){
                        console.log("Hull collision");
                    }
                });
            }
        });


        AFRAME.registerComponent('phase-shift', {
            init: function () {
                var el = this.el
                el.addEventListener('gripdown', function () {
                    el.setAttribute('collision-filter', {collisionForces: true})
                    console.log("button Press");
                })
                el.addEventListener('gripup', function () {
                    el.setAttribute('collision-filter', {collisionForces: false})
                    console.log("button let go");
                })
            }
        });
        
        AFRAME.registerComponent('delete-self', {
                schema:{
                    delete: {default: false}
                },
                init: function(){
                },

                tick: function(){
                    const Context_AF = this;
                    var el = this.el;
                    if(this.data.delete === true) {
                        Context_AF.deleteMyself();
                    }
                },

                deleteMyself: function(){
                    const Context_AF = this;
                    Context_AF.el.parentNode.removeChild(Context_AF.el); 
                }
            });
    </script>
  </head>
  <body>
    
    <a-scene physics="debug: true; iterations: 20">
      <a-assets>
          <a-asset-item id="kitchenTop-obj" src="assets/models/kitchenTop.obj"></a-asset-item>
          <a-asset-item id="knife-obj" src="assets/models/knife.obj"></a-asset-item>
          <a-asset-item id="mushroom-obj" src="assets/models/mushroom.obj"></a-asset-item>

          
          <a-asset-item id="pan1-obj" src="assets/models/pan1.obj"></a-asset-item>
          <a-asset-item id="pan2-obj" src="assets/models/pan2.obj"></a-asset-item>

          <a-mixin id="objectGrab" hoverable grabbable stretchable draggable
                event-set__hoveron="_event: hover-start; material.opacity: 0.7; transparent: true"
                event-set__hoveroff="_event: hover-end; material.opacity: 1; transparent: false"
                dynamic-body shadow delete-self="delete: false;" collision></a-mixin>
                
          <a-mixin id="cube" geometry="primitive: box;"
                 hoverable grabbable stretchable draggable
                 event-set__hoveron="_event: hover-start; material.opacity: 0.7; transparent: true"
                 event-set__hoveroff="_event: hover-end; material.opacity: 1; transparent: false"
                 dynamic-body shadow delete-self="delete: false;" collision></a-mixin>
          <a-mixin id="touch"
                    physics-collider phase-shift
                    collision-filter="collisionForces: false"
                    static-body="shape: sphere; sphereRadius: 0.02"
                    super-hands="colliderEvent: collisions;
                                  colliderEventProperty: els;
                                  colliderEndEvent: collisions;
                                  colliderEndEventProperty: clearedEls;">
      </a-assets>
      <a-entity>
          <a-camera positon="0 1.6 0"></a-camera>
          <a-entity id="rhand" mixin="touch"
                    vive-controls="hand: right"
                    oculus-touch-controls="hand: right"
                    windows-motion-controls="hand: right">
          </a-entity>
          <a-entity id="lhand" mixin="touch"
                    vive-controls="hand: left"
                    oculus-touch-controls="hand: left"
                    windows-motion-controls="hand: left">
          </a-entity>
      </a-entity>
      <a-sky color="#1e559e"></a-sky>
      <!--<a-entity class="cube" mixin="cube" position="0 1.4 -0.5" material="color: red"></a-entity>-->
      <a-entity static-body obj-model="obj: #kitchenTop-obj;" scale ="0.01 0.01 0.01"></a-entity>

      <a-entity  id="knife-entity" obj-model="obj: #knife-obj;" mixin="objectGrab" position="0.5 1.4 -0.5" material="color: black" scale ="0.02 0.02 0.02" knife-detection></a-entity>

      <a-entity id="mushroom-entity" obj-model="obj: #mushroom-obj;"  mixin="objectGrab" position="-0.4 4.4 -0.5" scale ="0.01 0.01 0.01" material="color: red" knife-detection></a-entity>

      <a-entity id="cube-entity" mixin="cube" position="0 1.1 -0.5" scale ="0.2 0.2 0.2" material="color: red"></a-entity>

      <a-plane id="plane" static-body position="0 0 0" scale="10 10 10" rotation="-90 0 0" color="#8E8E8E"></a-plane>
      
    </a-scene>
  </body>
</html>